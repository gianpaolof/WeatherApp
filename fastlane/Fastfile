# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)
platform :android do
    # private_lanes
    desc "Clean"
    private_lane :clean do
        gradle(task: "clean")
    end

    desc "Download dependencies"
    private_lane :download_dependencies do
    gradle(task: "androidDependencies")
    end

    desc "Setup variables"
    private_lane :setup_variables do
        BUILD_TYPE = ENV["BUILD_TYPE"]
        FIREBASE_APP_ID = ENV["FIREBASE_APP_ID"]
        FIREBASE_CI_TOKEN = ENV["FIREBASE_CI_TOKEN"]
        CHANNEL = ENV["CHANNEL"]
        SLACK_URL = ENV["SLACK_URL"]
    end

    # public_lanes
    desc "Unit tests"
    lane :tests do
      gradle(task: "test")
    end

    desc "Generate build and upload to firebase"
    lane :build do
    clean
    download_dependencies
    setup_variables
    slack_send(':crossed_fingers: Generating ' + 'Staging' + ' build', 'weather_app_release')
    gradle(
        task: "assemble",
        build_type: "Staging",
    )
    slack_send('Staging' + ' Build Successfully completed...:star-struck: \n Uploading to Firebase', 'weather_app_release')
    firebase_app_distribution(
        app: "1:829346185170:android:af75c842b479f438e0d20b",
        release_notes_file: "releaseNotes.txt",
        groups: "Internal",
        firebase_cli_token: "1//03v1Pl0r7AWorCgYIARAAGAMSNwF-L9IrkrlQOtK6f3EJkBDRWEPTvMLS3viAeKBidd2KRfo_Q6SYojKulLbeWZxo57ialwcxD30",
        debug: false
    )
    slack_send(':tada: Hooooooorrrayyyyy!!! ' + 'Staging' + ' Build is successfully uploaded on Firebase  Distribution!! :dancer::man_dancing:', 'weather_app_release')
    end
end

def slack_send(msg, channel)
    slack(
      slack_url: "https://hooks.slack.com/services/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",
      message: msg,
      success: true,
      channel: channel,
      default_payloads: []
    )
end